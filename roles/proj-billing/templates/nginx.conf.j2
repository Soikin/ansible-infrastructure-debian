# This file is managed by ansible, don't make changes here - they will be overwritten.
{% if billing_ssl %}
server {
    listen {{ ansible_default_ipv4.address }}:{{ nginx_default_http_port }};
    server_name {{ billing_hostname }} www.{{ billing_hostname }};
    return 301 https://$host$request_uri;
}
{% endif %}

server {
{% if billing_ssl %}
    listen {{ ansible_default_ipv4.address }}:{{ nginx_default_https_port }} ssl;
{% else %}
    listen {{ ansible_default_ipv4.address }}:{{ nginx_default_http_port }};
{% endif %}
    server_name {{ billing_hostname }} www.{{ billing_hostname }};

    access_log      /var/log/nginx/{{ billing_hostname }}.access.log;
    error_log       /var/log/nginx/{{ billing_hostname }}.error.log;

    root /usr/abills/cgi-bin;
    index index.cgi;
    charset utf-8;

    location ^~ /images/ {
        alias /usr/abills/Abills/templates/;
        location ~* \.(jpg|gif|png|css|js|JPG|GIF)$ {
            allow all;
        }
        deny all;
    }

    location ~ \.cgi|pm$ {
        try_files $uri =404;
        gzip off;
        fastcgi_param HTTPS on;
        fastcgi_pass unix:/var/run/fcgiwrap.socket;

        fastcgi_index index.cgi;
        fastcgi_param HTTP_CGI_AUTHORIZATION $http_authorization;
        fastcgi_param SCRIPT_FILENAME  /usr/abills/cgi-bin$fastcgi_script_name;
        include fastcgi_params;
    }

{% if billing_ssl %}
    # SSL
    ssl_certificate      /etc/nginx/ssl/{{ billing_hostname }}.crt;
    ssl_certificate_key  /etc/nginx/ssl/{{ billing_hostname }}.key;
    ssl_session_timeout  5m;
    ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers          HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers   on;
{% endif %}
}
