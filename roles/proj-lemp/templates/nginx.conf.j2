# This file is managed by ansible, don't make changes here - they will be overwritten.
{% if item.ssl %}
server {
  listen {{ ansible_default_ipv4.address }}:{{ nginx_default_http_port }};
  server_name {{ item.name }} www.{{ item.name }};
  return 301 https://$host$request_uri;
}
{% endif %}

server {
{% if item.ssl %}
  listen {{ ansible_default_ipv4.address }}:{{ nginx_default_https_port }} ssl;
  server_name {{ item.name }} www.{{ item.name }};
{% else %}
  listen {{ ansible_default_ipv4.address }}:{{ nginx_default_http_port }};
  server_name {{ item.name }} www.{{ item.name }};
{% endif %}

  access_log /var/log/nginx/{{ item.name }}.access.log;
  error_log /var/log/nginx/{{ item.name }}.error.log;

  root   /h/{{ item.user }}/{{ item.htdocs }};
  client_max_body_size 10M;

  location / {
    index  index.php;
    try_files $uri $uri/ /index.php?$args;
  }

  location ~ \.php$ {
    fastcgi_pass unix:{{ php_fpm_config_listen_sock }};
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
  }

{% if item.ssl %}
  include /etc/nginx/includes/letsencrypt.conf;
{% endif %}
{% if item.ssl %}
  # SSL
  ssl_certificate      /etc/letsencrypt/live/{{ item.name }}/fullchain.pem;
  ssl_certificate_key  /etc/letsencrypt/live/{{ item.name }}/privkey.pem;
  ssl_session_timeout  5m;
  ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers          HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers   on;
{% endif %}
}
